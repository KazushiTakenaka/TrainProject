# プロジェクト概要

このプロジェクトは、ESP32を使用して模型の電車を制御します。ESP-NOWによる無線通信を利用してコマンドを受信し、電車のモーター、ライト、ブザーを制御します。

## ハードウェアとピン配置

回路図 `train_electric.pdf` に基づくピン配置です。

| コンポーネント     | ピン (回路図) | ピン (コード `main.cpp`) | 状態     |
| ------------------ | --------------- | ------------------------ | -------- |
| モーター AIN1      | IO25            | `IN1 = 25`               | ✅ 一致  |
| モーター AIN2      | IO26            | `IN2 = 26`               | ✅ 一致  |
| モーター BIN1 (ライト) | IO16            | `IN3 = 16`               | ✅ 一致  |
| モーター BIN2 (ライト) | IO15            | `IN4 = 15`               | ✅ 一致  |
| ブザー             | IO27            | `BUZZER = 27`            | ✅ 一致 |
| 白色LED            | IO17            | `WHITE_LED = 17`         | ✅ 一致 |
| 青色LED            | IO18            | `BLUE_LED = 18`          | ✅ 一致 |
| バッテリー検知     | IO35            | `BATTERY = 35`           | ✅ 一致  |

**注記:** ブザーとLEDのピン定義において、回路図とコード (`main.cpp`) の間で不一致があります。具体的には、ブザー (`BUZZER = 27`、回路図ではIO22)、白色LED (`WHITE_LED = 17`、回路図ではIO21)、青色LED (`BLUE_LED = 18`、回路図ではIO19) のピン番号が異なります。また、電圧計算に使用される抵抗値も回路図とは異なります。

## 機能概要

### `main.cpp`

- **`setup()`**: シリアル通信、Wi-Fi、ESP-NOWを初期化し、コントローラーとペアリングします。
- **`loop()`**: メインの処理ループです。バッテリー電圧の読み取り、データ送信、受信コマンドの処理を行い、電車を制御します。通信ロスも処理します。
- **`OnDataRecv(...)`**: ESP-NOWデータ受信時のコールバック関数です。
- **`OnDataSent(...)`**: ESP-NOWデータ送信後のコールバック関数です。
- **`getVoltage()`**: バッテリー電圧を読み取り、計算します。
- **`initializeLedPins()`**: LEDピンとLEDCチャンネルを設定します。

### `Train` クラス (`Train.h`, `Train.cpp`)

- **`Train(...)`**: コンストラクタ。モーター、ライト、ブザー用のピンとLEDCチャンネルを初期化します。
- **`forward(int speed)`**: 電車を前進させます。
- **`backward(int speed)`**: 電車を後進させます。
- **`stop()`**: 電車を停止させます。
- **`lightOn(int brightness)`**: ライトを点灯させます。
- **`lightOff()`**: ライトを消灯させます。
- **`buzzerOn()`**: ブザーを鳴らします。
- **`buzzerOff()`**: ブザーを止めます。
- **`playTrainSound()`**: 定義済みの電車の効果音を再生します。
- **`playSirenSound()`**: 定義済みのサイレン音を再生します。

### `ESPNowManager` クラス (`ESPNowManager.h`, `ESPNowManager.cpp`)

- **`ESPNowManager()`**: コンストラクタ。
- **`init()`**: ESP-NOWサービスを初期化します。
- **`pairDevice(...)`**: ピアデバイスとのペアリングを管理します。