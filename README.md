# ESP32 タケレール

このプロジェクトは、ESP32を搭載したタケレール用のファームウェアです。ESP-NOWプロトコルを介してコントローラーから無線でコマンドを受信し、タケレールのモーター、ライト、ブザーを制御します。

## 機能

- **モーター制御:** タケレールの動作（前進、後進、停止）と速度を制御します。
- **ライト制御:** タケレールのライトを点灯・消灯します。
- **ブザー制御:** ブザーを操作し、定義済みの効果音を再生することも含みます。
- **無線通信:** ESP-NOWプロトコルを使用して、コントローラーとの低遅延通信を実現します。
- **バッテリー監視:** 自身のバッテリー電圧を測定し、コントローラーに送信します。
- **フェイルセーフ:** コントローラーとの通信が途絶えた場合、タケレールを自動的に停止させます。

## ハードウェア

### 必要なコンポーネント

- ESP32開発ボード (例: ESP32-DevKitC)
- モータードライバー (例: TB6612FNG)
- LED (ヘッドライト用)
- ブザー
- バッテリー

### ピン配置

| コンポーネント     | ESP32 ピン (コード内) |
| ------------------ | --------------------- |
| モーター AIN1      | `25`                  |
| モーター AIN2      | `26`                  |
| ライト BIN1        | `16`                  |
| ライト BIN2        | `15`                  |
| ブザー             | `27`                  |
| 白色LED            | `17`                  |
| 青色LED            | `18`                  |
| バッテリー検知     | `35`                  |

**注:** `main.cpp` 内のピン定義は、ハードウェアの回路図と異なる場合があります。正確なピン配置については、ソースコードを参照してください。

## ソフトウェア

このプロジェクトは、PlatformIOを使用してArduinoフレームワークで開発されています。

### 主要なファイルとクラス

- **`src/main.cpp`**: メインのアプリケーションロジックです。初期化、メインループ、受信データの処理を担当します。
- **`src/Train.h` / `src/Train.cpp`**: `Train`クラス。タケレールのハードウェア（モーター、ライト、ブザー）を制御するためのすべての機能をカプセル化しています。
- **`src/ESPNowManager.h` / `src/ESPNowManager.cpp`**: `ESPNowManager`クラス。ESP-NOW通信のセットアップと処理を管理します。
- **`platformio.ini`**: PlatformIOのプロジェクト設定ファイル。ボード、フレームワーク、依存関係を定義します。

## セットアップとビルド

### 事前準備

- [Visual Studio Code](https://code.visualstudio.com/)
- [PlatformIO IDE 拡張機能](https://platformio.org/install/ide?install=vscode)

### 手順

1.  **リポジトリをクローンする:**
    ```bash
    git clone <repository-url>
    cd <repository-directory>
    ```

2.  **コントローラーのMACアドレスを設定する:**
    `Secret.h`と`Secret.cpp`を開きます。`Secret.h`でコントローラーデバイスのMACアドレスを定義できます。`Secret.cpp`にコントローラーデバイスのMACアドレスを入力する必要があります。
    src/ディレクトリに移動させます。

    **`src/Secret.h`**
    ```cpp
    extern uint8_t controller_mac_addr[];
    ```
    **`src/Secret.cpp`**
    ```cpp
    #include "Secret.h"
    uint8_t controller_mac_addr[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}; // TODO:CHANGE YOUR MAC ADDRESS
    ```

3.  **ビルドとアップロード:**
    PlatformIO CLI（またはVS Codeのステータスバーのボタン）を使用して、ファームウェアをビルドし、ESP32にアップロードします。
    ```bash
    # プロジェクトをビルド
    pio run

    # ファームウェアをアップロード
    pio run --target upload
    ```

## 通信プロトコル

タケレールとコントローラー間の通信は、ESP-NOWによって処理されます。

- **`ReceivedDataPacket.h`**: コントローラーから受信するデータパケットの構造を定義します。モーターの速度、方向、ライト、ブザーのコマンドが含まれます。
- **`SaneDataPacket.h`**: タケレールからコントローラーに送信するデータパケットの構造を定義します。バッテリー電圧などのテレメトリデータが含まれます。